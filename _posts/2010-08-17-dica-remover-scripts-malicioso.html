---
layout: post
title: 'Dica: Remover scripts malicioso'
date: '2010-08-17T10:52:00.004-03:00'
author: Alexandre Bargiela
tags: 
modified_time: '2010-08-18T09:44:27.783-03:00'
thumbnail: http://4.bp.blogspot.com/_8nbx0pKfrDs/TGqRq2uQkTI/AAAAAAAAAss/L3kyFU_GhNQ/s72-c/invasao.jpeg
blogger_id: tag:blogger.com,1999:blog-7490778459153845376.post-4628776950917956777
blogger_orig_url: http://abargiela.blogspot.com/2010/08/dica-remover-scripts-malicioso.html
---

Tempo atrás enfrentei alguns problemas de segurança em um ambiente com (LAMP), nos quais o atacante conseguia colocar c99shell.php c100.php whatever.php com conteúdo malicioso ou injetar um código malicioso no meio da pagina que geralmente retornava a seguinte tela para o usuário final:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_8nbx0pKfrDs/TGqRq2uQkTI/AAAAAAAAAss/L3kyFU_GhNQ/s1600/invasao.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_8nbx0pKfrDs/TGqRq2uQkTI/AAAAAAAAAss/L3kyFU_GhNQ/s320/invasao.jpeg" /></a></div><br />Antes de instalarmos ossec, ajustes finos de segurança no PHP, foram tomadas algumas atitudes, então gostaria de compartilhar algo que parece óbvio porém acredito que mesmo assim pode ser útil.<br /><br /><br />Ajustes de permissão:<br />A não ser locais aonde precisam-se ser feito upload de arquivos(mesmo assim sugiro que seja feita uma verificação via programação para que verifique se o arquivo que está sendo enviado seja realmente o que você aceita) adicionar nessas pastas um .htaccess contendo <br />php_flag engine off<br />isso fará com que dentro dessa pasta não seja permitido executar nenhum .php o que aumenta a segurança do diretório.<br /><br />Quanto a permissão sugiro as seguintes permissões:<br />Pastas que não precisam ser inseridos dados - 555<br />Arquivos que não precisam ser alterados - 444<br />Pastas que precisam ser inseridos dados - 775<br />Arquivos que precisam ser alterados - 664<br />Usar usuário.grupo (Usuário e grupo do webserver)<br /><div style="color: #444444; font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://pt.wikipedia.org/wiki/Chmod"><i>http://pt.wikipedia.org/wiki/Chmod</i></a></div><div style="color: #444444; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><a href="http://pt.wikipedia.org/wiki/Chown"><i style="color: #444444; font-family: &quot;Courier New&quot;,Courier,monospace;">http://pt.wikipedia.org/wiki/Chown</i></a><br /><br />Algumas dicas para ajustar a permissão mais facilmente:<br /><span style="font-family: Courier New,Courier,monospace;">find /path1/path2/ -type d -exec chmod 0555&nbsp; {} \; #Pastas<br />find </span><span style="font-family: Courier New,Courier,monospace;">/path1/path2/</span><span style="font-family: Courier New,Courier,monospace;"> -type f -exec chmod 0444&nbsp; {} \; #Arquivos<br /><br />find </span><span style="font-family: Courier New,Courier,monospace;">/path1/path2/</span><span style="font-family: Courier New,Courier,monospace;"> -type d -exec chmod 0775&nbsp; {} \; #Pastas que podem ser alteradas<br />find </span><span style="font-family: Courier New,Courier,monospace;">/path1/path2/</span><span style="font-family: Courier New,Courier,monospace;"> -type f -exec chmod 0664&nbsp; {} \; </span><span style="font-family: Courier New,Courier,monospace;">#Arquivos que podem ser alteradas</span><br /><br /><br />Com esses pontos já temos um grande avanço na segurança, porém pretendo em breve aumentar essa documentação relatando mais coisas que foram feitas para ajustar o ambiente e estabiliza-lo.<br /><br />Caso você já esteja com o script infiltrado em seu servidor uma alternativa para localiza-lo é procura-lo por palavras chaves que possivelmente encontrariamos dentro dos .php como:<br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">find /path1/path2/ -name "*.php" -exec grep "Liloss" {} \; -print</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;">find /path1/path2/&nbsp; -name "*.php" -exec grep -i "Adobe FlashPlayer" {} \; -print</span><br /><span style="font-size: small;">find /path1/path2/&nbsp; -name "*.php" -exec grep -i "system(" {} \; -print</span><br /><span style="font-size: small;">find /path1/path2/ -name "*.php" -exec grep -i "s0n_g0ku" {} \; -print</span></div><br />Sendo que esses valores podem ser alterados analise o que está acontecendo em sua infra e ajuste o find para ela. <br /><br />abs a todos.<br />:D