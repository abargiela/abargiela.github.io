---
layout: post
title: Memcached daemon + memcache com php
date: '2010-07-20T17:36:00.040-03:00'
author: Alexandre Bargiela
tags: 
modified_time: '2012-12-27T15:28:57.918-02:00'
blogger_id: tag:blogger.com,1999:blog-7490778459153845376.post-4468057290912660003
blogger_orig_url: http://abargiela.blogspot.com/2010/07/memcached-daemon-memcache-com-php.html
---

Tempos atrás eu me deparei com um problema de alto consumo do banco de dados e uma das alternativas para amenizar o problema foi utilizarmos o memcached, agora a pouco tempo tive que realizar uma nova configuração do mesmo e então resolvi documentar para que tanto eu, quanto todos que acessem esse blog possam ter como base essa implementação e assim ter algum tipo de auxilio, ou sugerir melhorias para essa minha implementação.<br /><br />O memcached é uma ferramenta openSource que visa a alta performance do servidor, fazendo com que tanto a aplicação quanto o servidor passem a ter uma performance satisfatória.<br /><br />Aqui falaremos sobre o Daemon do memcached, e logo após do módulo do memcache para o&nbsp; PHP que prove um meio de se programar de forma mais simples utilizando funções do mesmo.<br /><br /><br />####################<br /># MENCACHED DAEMON #<br />####################<br /><br />- Acesse:<br />http://code.google.com/p/memcached/downloads/list<br />- Faça o download da última versão estável.<br /><br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>wget -c http://memcached.googlecode.com/files/memcached-1.4.5.tar.gz</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>tar -xzvf memcached-1.4.5.tar.gz</b></div><br />- Acesse a pasta do memcached:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>cd /home/user/memcached-1.4.5/</b></div><br />- Para compilar você pode ajustar para uma forma que mais se ajuste para seu ambiente, você pode verificar os parâmetros através de:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>./configure --help</b></div><br />- Em meu caso, para atender o que necessito bastou:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>./configure&nbsp; --prefix=/opt/memcached-1.4.5 --enable-64bit</b></div><br />- Enquanto compilava obtive o seguinte erro:<br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: #cc0000;">checking for libevent directory... configure: error: libevent is required.&nbsp; You can get it from http://www.monkey.org/~provos/libevent/</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: #cc0000;">If it's already installed, specify its path using --with-libevent=/dir/</span></div><br />- Como estou utilizando em meu ambiente debian bastou utilizar um<b style="font-family: &quot;Courier New&quot;,Courier,monospace;"> <span style="background-color: black; color: lime;">apt-get install libevent-dev</span></b> e solucionou meu problema, porém basta verificar o gerenciador de pacotes de você utiliza e adequar, ou então passar o diretório caso você possua a libevent já instalada em algum lugar de seu servidor.<br /><br /><br />- Se nenhum outro warning aparecer, basta executar um:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>make &amp;&amp; make install </b></div><br />- E sucesso, seu memcached está instalado em /opt/memcached-1.4.5<br /><br />- Agora você se pergunta.... o que fazer?<br /><br />- Vamos dar um start no serviço! Para isso existem diversos scripts espalhados na internet, e também o próprio script que está no .tar.gz do memcached.<br />Eu optei nessa dica por criar um script simples, portanto ele precisa de melhorias e está aberto a criticas construtivas.<br /><br />Link para o script:<br /><a href="https://github.com/abargiela/scripts/blob/master/init_memcached.sh">https://github.com/abargiela/scripts/blob/master/init_memcached.sh</a><br /><div style="color: #cc0000;"><b><a href="http://pastebin.com/EyMFTJ1Z">http://pastebin.com/EyMFTJ1Z</a></b><br /><br /></div>- Mova o script memcached-init para /etc/init.d/memcached-init, e faça um link simbolico para o seu rc, para verificar qual você utiliza, de um rulevel:<br />N 2<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>ln -s /etc/init.d/memcached-init&nbsp; /etc/rc2.d/S99memcached-init</b></div><br />Considero as 2 formas acima correta, portanto verifique qual a melhor para você.<br /><br />- Ajuste a permissão para nobody.<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>chown nobody.root /opt/memcached-1.4.5/</b></div><br />- Caso queria verificar o log, ele se encontra em /opt/memcached-1.4.5/log/memcached_log.txt<br />- É basicamente isso não tem muito segredo, qualquer dúvida estamos ai.<br /><br /><br /><br />#####################<br /># Extension MEMCACHE PHP&nbsp; #<br />#####################<br /><br />- Acesse http://pecl.php.net/package/memcache<br />- Faça o download da ultima versão estável.<br /><br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>wget -c http://pecl.php.net/get/memcache-2.2.5.tgz</b></div><br />- Descompacte o pacote:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>tar -xzvf memcache-2.2.5.tgz</b></div><br />- Acesse a pasta:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>cd&nbsp; memcache-2.2.5</b></div><br />- Agora o processo é simples, mantenha-se dentro da pasta do memcache, e execute:<br />--&gt; <b style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="background-color: black; color: lime;">phpize</span></b> (obs.: caso você tenha compilado o php e especificado o prefix, o caminho do phpize pode variar)<br />- No meu caso:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>/opt/php/bin/phpize</b></div>- Depois:<br /><span style="background-color: black; color: lime;"><b style="font-family: &quot;Courier New&quot;,Courier,monospace;">./configure --with-php-config=/opt/php/bin/php-config</b> </span>(também é necessário especificar)<br />--&gt; <span style="color: red;">Peguei um erro de compilação pois o memcache necessitava da ZLIB instalei zlib1g-dev&nbsp;</span> e compilou normalmente, portante fique atento antes de continuar a compilação para corrigir os eventuais erros.<br />- Caso não de erro:<br /><br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>make &amp;&amp; make install</b></div><br />- Ao final irá aparecer algo como:<br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">Installing shared extensions:&nbsp;&nbsp;&nbsp;&nbsp; /opt/php/lib/php/extensions/no-debug-non-zts-20060613/</div><br />- Pegue esse caminho pois o memcache.so estará la vamos até o php.ini:<br />/opt/php-5.2.6/lib/php.ini (no meu caso esse é o path do php.ini)<br />- Vá até a parte das extensions e adicione:<br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">extension=/opt/php-5.2.6/lib/php/extensions/no-debug-non-zts-20060613/memcache.so</div>- Salve e saia.<br />- Reinicie seu apache.<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>/opt/apache/bin/apachectl restart</b></div>- Para verificar se o memcache está funcionando como o esperado:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>/opt/php/bin/php -i | grep -i --color memcache</b></div>- O retorno do comando acima deverá ser algo similar a:<br /><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache support =&gt; enabled</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.allow_failover =&gt; 1 =&gt; 1</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.chunk_size =&gt; 8192 =&gt; 8192</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.default_port =&gt; 11211 =&gt; 11211</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.default_timeout_ms =&gt; 1000 =&gt; 1000</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.hash_function =&gt; crc32 =&gt; crc32</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.hash_strategy =&gt; standard =&gt; standard</b></div><div style="background-color: black; color: lime; font-family: &quot;Courier New&quot;,Courier,monospace;"><b>memcache.max_failover_attempts =&gt; 20 =&gt; 20</b></div><br />Referencias:<br />http://pecl.php.net/package/memcache<br />http://code.google.com/p/memcached/wiki/NewStart?tm=6<br />http://www.php.net/memcache <br /><br />:D