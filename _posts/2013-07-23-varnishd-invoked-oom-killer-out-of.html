---
layout: post
title: 'varnishd invoked oom-killer [ Out Of Memory no Varnish ] '
date: '2013-07-23T19:33:00.001-03:00'
author: Alexandre Bargiela
tags: 
modified_time: '2013-07-24T11:49:32.452-03:00'
blogger_id: tag:blogger.com,1999:blog-7490778459153845376.post-8891986336952434156
blogger_orig_url: http://abargiela.blogspot.com/2013/07/varnishd-invoked-oom-killer-out-of.html
---

Hoje nos deparamos com um problema que já vinha ocorrendo porém não havia sido pego, mas graças a uma outra monitoração adicionada, foi detectado &nbsp;que o varnish estava consumindo mais memória do que poderia ou tinha disponível para ele, e ocasionando um OOM, segue a saída do dmesg e do syslog:<br /><br />- dmesg:<br /><br /><i><span style="color: #444444;">[22804397.963962] Out of memory: Kill process 1316 (varnishd) score 976 or sacrifice child</span></i><br /><i><span style="color: #444444;">[22804397.976351] Killed process 1316 (varnishd) total-vm:52876488kB, anon-rss:31908748kB, file-rss:0kB</span></i><br /><i><span style="color: #444444;">[22811179.340584] varnishd invoked oom-killer: gfp_mask=0x201da, order=0, oom_adj=0, oom_score_adj=0</span></i><br /><i><span style="color: #444444;">[22811179.340590] varnishd cpuset=/ mems_allowed=0-1</span></i><br /><i><span style="color: #444444;">[22811179.340594] Pid: 12535, comm: varnishd Tainted: G &nbsp; &nbsp; &nbsp; &nbsp; C &nbsp; 3.2.0-23-generic #36-Ubuntu</span></i><br /><i><span style="color: #444444;">[22811179.340597] Call Trace:</span></i><br /><div><br /></div><br />- /var/log/syslog<br /><i><span style="color: #444444;">&nbsp;varnishd invoked oom-killer: gfp_mask=0x201da, order=0, oom_adj=0, oom_score_adj=0</span></i><br /><div><br /></div><div>Percebemos após análise que o problema poderia ser referente ao uso do amazenamento transiente: &nbsp;<a href="https://www.varnish-cache.org/docs/trunk/users-guide/storage-backends.html#transient-storage">https://www.varnish-cache.org/docs/trunk/users-guide/storage-backends.html#transient-storage</a></div><div><br /></div><div>Em nosso caso ele estava setado:&nbsp;</div><div><div><span style="color: #444444;"><i># varnishadm -T localhost:79 param.show &nbsp;shortlived</i></span></div><div><span style="color: #444444;"><i>shortlived &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10.000000 [s]</i></span></div><div><span style="color: #444444;"><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Default is 10.0</i></span></div><div><span style="color: #444444;"><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Objects created with TTL shorter than this are</i></span></div><div><span style="color: #444444;"><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; always put in transient storage.</i></span></div></div><div><br /></div><div>E percebemos lendo sobre &nbsp;o armazenamento transiente:&nbsp;</div><div><br /></div><div><div><i>"<span style="color: #444444;">Transient Storage</span></i></div><div><span style="color: #444444;"><i><br /></i></span></div><div><i><span style="color: #444444;">If you name any of your storage backend "Transient" it will be used for transient (short lived) objects. By default Varnish would use an</span> <b><span style="color: red;">unlimited malloc</span> </b><span style="color: #444444;">backend for this."</span></i></div></div><div>Ou seja, o Varnish irá utilizar toda a memória se não limitarmos, então decidimos por segurança, setar um limite.</div><div><br /></div><div>Em meu caso, respeitando a regra do:&nbsp;<a href="https://www.varnish-cache.org/trac/wiki/Performance">https://www.varnish-cache.org/trac/wiki/Performance</a></div><div>De utilizar:&nbsp;</div><ul style="background-color: white; color: #333333; font-family: Verdana, Arial, 'Bitstream Vera Sans', Helvetica, sans-serif; font-size: 13px;"><li>-s malloc,(YOURMEMORY-20%)G</li></ul><div>Em meu caso, tinha 32GB de memória RAM, então separei 24GB para o malloc, e 2GB para o&nbsp;Transient=malloc, ficando da seguinte forma no /etc/default/varnish:</div><div><br /></div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -s Transient=malloc,2G \</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -s malloc,24G \</div></div><div><br /></div><div>Aparentemente após essa limitação, nossos problemas com OOM(Out of Memory) acabaram, e a vida voltou ao normal :)</div><div><br /></div><div><i>Referências: &nbsp;<a href="https://www.varnish-cache.org/trac/wiki/Performance">https://www.varnish-cache.org</a>&nbsp;/ <a href="http://google.com/">http://google.com</a></i><br /><i>Participação/ajuda Especial: Valter Lisboa (GigaNerds)&nbsp;</i><a href="http://giganerds.wordpress.com/">http://giganerds.wordpress.com/</a></div>